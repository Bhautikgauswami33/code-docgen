<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        h1 { color: #2563eb; }
        h2 { margin-top: 30px; }
        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        input, textarea {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>API Test Page</h1>
    
    <h2>Authentication API Tests</h2>
    
    <div>
        <h3>Register</h3>
        <input type="text" id="registerUsername" placeholder="Username">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password">
        <button onclick="register()">Register</button>
        <pre id="registerResult"></pre>
    </div>
    
    <div>
        <h3>Login</h3>
        <input type="text" id="loginUsername" placeholder="Username or Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <label>
            <input type="checkbox" id="rememberMe"> Remember me
        </label>
        <button onclick="login()">Login</button>
        <pre id="loginResult"></pre>
    </div>
    
    <div>
        <h3>2FA Status</h3>
        <button onclick="check2FAStatus()">Check 2FA Status</button>
        <pre id="twoFAStatusResult"></pre>
    </div>
    
    <div>
        <h3>2FA Setup</h3>
        <button onclick="setup2FA()">Setup 2FA</button>
        <div id="qrCodeContainer" style="display: none;">
            <img id="qrCode" alt="QR Code" style="max-width: 200px;">
            <p>Secret Key: <span id="secretKey"></span></p>
            <p>Backup Codes:</p>
            <pre id="backupCodes"></pre>
            <input type="text" id="verificationCode" placeholder="Enter verification code">
            <button onclick="verify2FASetup()">Verify Setup</button>
        </div>
        <pre id="twoFASetupResult"></pre>
    </div>
    
    <div>
        <h3>Current User</h3>
        <button onclick="getCurrentUser()">Get Current User</button>
        <pre id="userResult"></pre>
    </div>
    
    <div>
        <h3>Logout</h3>
        <button onclick="logout()">Logout</button>
    </div>
    
    <script>
        const apiBaseUrl = '/api';
        
        async function makeRequest(url, method, data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                credentials: 'include'
            };
            
            // Add Authorization header if token exists
            const token = localStorage.getItem('token');
            if (token) {
                options.headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Add body for non-GET requests
            if (method !== 'GET' && data) {
                options.body = JSON.stringify(data);
            }
            
            try {
                const response = await fetch(`${apiBaseUrl}${url}`, options);
                const result = await response.json();
                return {
                    status: response.status,
                    data: result
                };
            } catch (error) {
                console.error('API request error:', error);
                return {
                    status: 500,
                    data: { error: error.message }
                };
            }
        }
        
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            
            if (!username || !email || !password) {
                document.getElementById('registerResult').textContent = 'Please fill all fields';
                return;
            }
            
            const result = await makeRequest('/auth/register/', 'POST', {
                username,
                email,
                password
            });
            
            document.getElementById('registerResult').textContent = JSON.stringify(result, null, 2);
            
            if (result.status === 201) {
                document.getElementById('registerResult').classList.add('success');
                document.getElementById('loginUsername').value = username;
            } else {
                document.getElementById('registerResult').classList.add('error');
            }
        }
        
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            if (!username || !password) {
                document.getElementById('loginResult').textContent = 'Please fill all fields';
                return;
            }
            
            const result = await makeRequest('/auth/login/', 'POST', {
                username,
                password,
                remember_me: rememberMe
            });
            
            document.getElementById('loginResult').textContent = JSON.stringify(result, null, 2);
            
            if (result.status === 200) {
                document.getElementById('loginResult').classList.add('success');
                
                // Handle 2FA if required
                if (result.data.two_factor_required) {
                    // Store user ID for 2FA verification
                    localStorage.setItem('temp_user_id', result.data.user_id);
                    document.getElementById('loginResult').textContent += '\n\n2FA required! Please enter code.';
                } else {
                    // Store tokens
                    localStorage.setItem('token', result.data.access);
                    localStorage.setItem('refreshToken', result.data.refresh);
                    localStorage.setItem('username', result.data.user?.username || username);
                    
                    document.getElementById('loginResult').textContent += '\n\nAuthenticated successfully!';
                }
            } else {
                document.getElementById('loginResult').classList.add('error');
            }
        }
        
        async function check2FAStatus() {
            const result = await makeRequest('/auth/2fa/status/', 'GET');
            document.getElementById('twoFAStatusResult').textContent = JSON.stringify(result, null, 2);
        }
        
        async function setup2FA() {
            const result = await makeRequest('/auth/2fa/setup/', 'POST');
            document.getElementById('twoFASetupResult').textContent = JSON.stringify(result, null, 2);
            
            if (result.status === 200) {
                document.getElementById('qrCodeContainer').style.display = 'block';
                document.getElementById('qrCode').src = result.data.qr_code;
                document.getElementById('secretKey').textContent = result.data.secret_key;
                document.getElementById('backupCodes').textContent = result.data.backup_codes.join('\n');
            }
        }
        
        async function verify2FASetup() {
            const code = document.getElementById('verificationCode').value;
            
            if (!code) {
                document.getElementById('twoFASetupResult').textContent = 'Please enter verification code';
                return;
            }
            
            const result = await makeRequest('/auth/2fa/verify-setup/', 'POST', { code });
            document.getElementById('twoFASetupResult').textContent = JSON.stringify(result, null, 2);
        }
        
        async function getCurrentUser() {
            const result = await makeRequest('/auth/user/', 'GET');
            document.getElementById('userResult').textContent = JSON.stringify(result, null, 2);
        }
        
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('username');
            localStorage.removeItem('temp_user_id');
            alert('Logged out successfully!');
        }
    </script>
</body>
</html>
